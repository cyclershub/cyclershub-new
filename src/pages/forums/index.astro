---
import { prisma } from "../../lib/shared";
import ForumLayout from "../../layouts/ForumLayout.astro";
import { refreshAccessToken } from "../../lib/refreshAccessToken";
import { Bookmark, EyeOpen, Pencil1, Person } from "radix-svelte-icons";
import moment from "moment";

await refreshAccessToken(Astro);

const forums = await prisma.forum.findMany({
	include: {
		_count: {
			select: {
				threads: true,
				subscribers: true,
			},
		},
	},
});

const newThreads = await prisma.thread.findMany({
	orderBy: {
		created_at: "desc",
	},
	include: {
		forum: true,
	},
	take: 4,
});
---

<ForumLayout title="The CyclersHub">
	<div class="py-16">
		{
			forums.map((forum) => (
				<a href={`/forums/${forum.slug}`} class="no-underline grid grid-cols-2 gap-4 bg-base-300 rounded-sm">
					<img
						src={forum.banner}
						class="object-fit my-0 rounded-l-sm"
						alt=""
					/>
					<div class="p-6 flex flex-col justify-between">
						<div>
							<h2 class="text-3xl my-0 mb-4">{forum.title}</h2>
							<p class="text-xl">{forum.description}</p>
						</div>
						<div>
							<div class="flex flex-row gap-8">
								<span class="flex flex-row gap-2 text-lg">
									<Bookmark size={24} />{" "}
									{forum._count.subscribers}
								</span>
								<span class="flex flex-row gap-2 text-lg">
									<Pencil1 size={24} /> {forum._count.threads}
								</span>
								<span class="flex flex-row gap-2 text-lg">
									<EyeOpen size={24} /> {forum.views}
								</span>
							</div>
							<span class="flex flex-row gap-2 text-lg">
								Created{" "}
								{moment(forum.created_at).format(
									"MMMM DD, YYYY"
								)}
							</span>
						</div>
					</div>
				</a>
			))
		}
	</div>
	<div slot="aside">
		<div
			class="mt-16 h-16 w-full bg-base-200 relative grid grid-cols-[1fr_300px] justify-between items-center px-6"
		>
			<h2 class="my-0">News</h2>
		</div>
		<div class="bg-base-300">
			{
				newThreads.map((newThread) => (
					<a
						href={`/forums/${newThread.forum.slug}/${newThread.slug}`}
						class="px-6 py-4 flex flex-row"
					>
						{newThread.title}
					</a>
				))
			}
		</div>
	</div>
</ForumLayout>
